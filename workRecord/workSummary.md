## JH项目总结
### 人脸模组项目开发总结
- **MCU（微控制器）:  君正x2100**
- 
- 人脸模组项目开发总结涵盖：功能实现与优化，包括SDK编译烧录、人脸识别算法（第三方与自研）、UART串口通信、UVC/UAC协议、RGB/IR图像处理、LCD驱动、系统优化及量产工具。重点解决串口不稳定、UVC兼容性、图像噪点、IR控制功耗、系统启动速度等问题，并针对不同硬件版本优化量产流程。
- 人脸模组开发
  - 功能开发
    - 方案SDK编译烧录固件，包括烧录工具使用说明、SDK更新同步等功能模块
    - 人脸识别算法测试与优化，涵盖第三方算法库测试和自研算法开发
    - UART串口通信协议实现与问题解决，包括商汤协议和硬件适配
  - 图像处理
    - RGB图像处理与ISP调校，涉及帧率、分辨率、去噪点等关键技术
    - IR图像控制与驱动开发，包括raw10转gray8和IR灯控制策略
    - UVC与UAC功能实现，解决双码流和音频杂音等难题
  - 系统优化
    - 快速启动与固件打包优化，通过调整flash时钟频率和编译选项提升性能
    - 系统bug修复与功耗管理 解决浮点数处理和供电不足等问题
    - 量产工具与硬件版本管理 支持多种硬件配置和生产需求

- **功能**
  1. **方案SDK编译烧录固件**
    - 烧录工具说明
      - 系统
        - Windows
        - Ubuntu
      - 配置
        - 设备系统类型：Linux、freeRTOS
        - flash类型
        - 烧录区域
        - 整包与分包烧录
      - 触发烧录模式
        - 软触发：命令
        - 硬件触发：短接bootsel
    - SDK更新同步
      - 功能验证
      - 同步代码到gitlab
    - 功能模块使用示例
    - 系统模块功能开启与关闭配置
    - 方案SDK功能bug交互
    - 使用方案商的技术资源协助
  2. **人脸识别算法**
    - 第三方算法库测试：君正、阿里达摩院
      - 录入、识别
      - 接口性能测试：**主要是客户高频率使用的功能识别速度**
      - 日志追踪接口是否有异常
      - 功能性
      - 稳定性
      - 异常
      - 系统运行环境监测
      - 设备外部环境、室内、室外、正光、逆光、侧光，设备外部结构（锁体内部漏光、串扰）
      - 照片假体测试：A4纸、牛皮纸、油纸
      - INCBIN编译时加载模型 或运行起来后再读nor flash 
    - 荆虹自研算法
      - 使用ncnn推理框架
      - 采集大量人员的ir图像进行活体训练：室内正常工作环境、窗口正、逆、侧光，室外
      - 测试与第三方一致
      - 人脸探测、特征点提取、角度评估、活体检测、闭眼检测、张嘴检测
      - 更新算法模型：活体模型、识别模型、探测模型
      - 过滤异常的人脸特征点数据
      - 录入时判断连续两帧比对值 保证录入图像质量
      - 修改活体阈值与对比阈值适配人脸识别效果
    - 算法速度优化
      - resize减小人脸框
  3. **uart TTL串口**
    - 商汤协议
      - 录入
      - 识别
      - 查询
      - 删除
      - 中断
      - 断电重启
      - 算法等级设置
      - 获取版本号
      - 获取SN号
      - OTA：通过uart传输升级数据
      - 抓拍
      - 加密通信：AES128、异或取反
      - 日志
    - 添加
      - 设置曝光
      - 设置增益
      - 配置LCD尺寸
      - 配置logo显示
      - 控制ir灯
    - 难点与问题点
      - 串口通信不稳定 导致程序挂掉 需要将通信模式由轮询改为中断
      - 协议文档不全及不够详细 导致协议功能实现有偏差
      - 对端设备协议功能实现不完善，有偏差，需要适配，抓包做逆向工程
      - 对端设备性能或功能逻辑不完备，回应太快导致对端设备接收不到
      - 因驱动能力不足 串口通信失败 需要加上拉电阻 或加大上拉电阻 可开启主控芯片内部上拉
  4. **UVC** 
     1. uvc
        1. 图像类型
        2. 分辨率列表
        3. 帧率列表
        4. 用于镜头调焦
        5. 采集raw图
     2. uac
        1. 喇叭与麦设备
     3. 双码流
        1. 一个 `USB视频设备`（如摄像头）同时提供两个独立的视频数据流
     4. uvc扩展协议
        1. 添加新的指令
        2. 可用于传输数据：包大小64kb    
     5. 难点与问题
        1. uvc不通 UVC帧头timestamp、alt值、包大小512、全速模式、bulk模式不匹配、jpg编解码类型
        2. 喇叭有杂音 清掉杂音数据
        3. 喇叭驱动芯片差 导致掉电时有尾杂音
        4. 延时 可视对讲要求实时性
  5. **RGB图像**
     1. 图像
        1. 帧率
        2. 分辨率
        3. 缩放与裁剪：获取各种分辨率 影响FOV、清晰度
        4. jpg软、硬编码
        5. 去噪点算法
        6. NV12旋转
        7. ir与rgb双通镜头
     2. ISP
        1. 使用luma与曝光时间实现软光敏
        2. 图像亮度
        3. 清晰度
        4. 噪点
        5. 窗口亮环境过曝
        6. 色彩偏蓝、偏黄，Rgian、Bgian
        7. 图像翻转和镜像
     3. 驱动
        1. 点亮sensor：mipi/dvp，I2C号、I2C地址、VIC控制器、RESET、PWDN、POWER、ISP效果文件
        2. sensor寄存器初始化列表：由sensor方案商提供
        3. 分辨率、帧率（vts、hts）接口
        4. ISP接口：色度、锐度、饱和度、亮度、对比度、ROI
     4. 硬件问题
        1. 有横纹，电源不稳定干扰信号
        2. 图像有幻影色卡，红外灯亮时干扰图像信号
     5. sensor list
        1. SC2355
        2. GC1054
        3. SC1346
        4. GC2053
     6. 超广角镜头
        1. 画中画，大画面为畸变校正后的图像，小画面为关注某区域的画面
     7. 鱼眼镜头
  6. **IR图像**
     1. 图像
        1. raw10转gray8
        2. gray8旋转
     2. IR控制
        1. 使用驱动芯片aw36515 控制效果好 但成本高
        2. pwm控制
        3. 在sensor驱动开始曝光处亮灯，算法处理慢，一直产生图像时灯一直亮 造成温度高功耗高
        4. 算法取帧位置亮灯，需要清缓存的非亮帧，消耗时间，
        5. IR灯选用默认下拉灯pwm管脚 而不是默认上拉 避免上电亮灯
     3. 驱动
        1. 点亮sensor: mipi/dvp、I2C号、I2C地址、VIC控制器、RESET、PWDN、POWER、STROBE
        2.  sensor寄存器初始化列表：由sensor方案商提供
        3. 分辨率、帧率（vts、hts）接口
     4. 问题
        1. ir图像有纹路 需要设置sensor寄存器打开binning优化
        2. 曝光策略抓取到算法可使用的图像：轮询曝光列表、根据亮度值二分查找
  7. **系统**
     1. 快速启动
        1. 去掉文件系统 直接读写nor flash
        2. flash时钟频率改到最高320MHZ
        3. 编译优化选项 -Ofast
        4. 去掉所有正常逻辑的log
     2. 固件打包
        1. uboot、ota、freeRTOS、model、user data
        2. 各部分需要按照某长度对齐
     3. 系统bug
        1. 比对逻辑出错 浮点数处理问题
        2. 系统挂掉 供电不足
     4. 编译管理
        1. 使用编译脚本控制代码编译时选择：硬件配置、硬件版本、客户名称、功能开关
     5. ubuoot
        1. 控制gpio管脚
        2. 根据OTA分区信息，启动固件
     6. 看门狗重启
        1. 程序挂掉
        2. 程序异常
        3. 可通过读取寄存器值判断启动状态
     7. 功能启动顺序与关联性
        1. 最开始将人脸算法与ir取图像功能运行，能更快识别人脸
        2. 默认ir寄存器配置最快出流
        3. uart与USB电源探测：探测到上电才初始化对应的功能 降低对其他功能的性能影响 降低功耗
     8. 读取量产固件
        1. 需读取nor flash，编译出的固件需用方案商的烧录工具烧录 期间会写入一些flash相关的信息
     9. 功耗
        1.  使用功率计测试功耗：最大电流、平均电流
     10. 优化内存消耗
        1. 尽量共用buf
        2. 减少线程栈大小
     11. CPU消耗
        1.  错开功能运行
        2.  使用第二个核




### 单点测距项目总结




### 扫码项目总结
